# SMC_MASTER_EMBEDDING

# Authoritative Smart Money Concepts Framework

This document defines SMC logic used across all symbols.

It must follow system hierarchy and may not override the OS Layer or PRL.

---

## SYSTEM HIERARCHY REQUIREMENTS

This document must defer to:

1. KNOWLEDGE_DOC_EMBEDDING (OS Layer)
2. Professional Reasoning Layer (PRL)
3. Validation Layer
4. Volatility & Regime Framework
5. Liquidity & Structure Framework
6. Global Breakout Framework
7. Symbol-Specific Behaviour Docs

If any conflict occurs, the higher-level document wins.

---

## GLOBAL SAFETY RULES

- Never infer BOS, CHOCH, sweep, OB, FVG, displacement or trend.
- Structure must come from tools or user-described charts only.
- Always fetch fresh price before applying SMC reasoning.
- Tool: `moneybot.getCurrentPrice(symbol: "XAUUSD")` - MUST use before SMC analysis
- Analysis Tool: `moneybot.analyse_symbol_full(symbol: "XAUUSD")` - Provides SMC structure data
- SMC cannot generate directional predictions.
- Regime, volatility and session must align before SMC concepts apply.
- Mid-range = invalid for SMC entries unless explicitly defined as a scalp regime.
- If structure unclear → classify as Chop regime.

## TOOL_INTEGRATION

**Price Fetching:**
- tool: `moneybot.getCurrentPrice`
- when: Before ANY SMC analysis
- parameters: `symbol` (string, required)

**Structure Analysis:**
- tool: `moneybot.analyse_symbol_full`
- when: For comprehensive SMC structure analysis
- returns: SMC structure data in `response.data` (BOS, CHOCH, Order Blocks, FVG, etc.)
- parameters: `symbol` (string, required)
- **MTF CHOCH/BOS Data**:
  - `analyse_symbol_full` provides CHOCH/BOS detection per timeframe in `response.data.smc.timeframes.*`
  - Each timeframe (H4, H1, M30, M15, M5) includes: `choch_detected`, `choch_bull`, `choch_bear`, `bos_detected`, `bos_bull`, `bos_bear`
  - Aggregated CHOCH/BOS fields available at:
    - `response.data.smc.choch_detected` - CHOCH detected on any timeframe (calculated from all timeframes)
    - `response.data.smc.bos_detected` - BOS confirmed on any timeframe (calculated from all timeframes)
  - Primary trend available at: `response.data.smc.trend` (extracted from H4 bias: "BULLISH", "BEARISH", "NEUTRAL", "UNKNOWN")

**Plan Creation (SMC-based):**
- tool: `moneybot.create_order_block_plan` (for Order Block setups)
- tool: `moneybot.create_choch_plan` (for CHOCH setups)
- tool: `moneybot.create_auto_trade_plan` (for general SMC setups)
- parameters: Must include appropriate `conditions` object matching SMC pattern

---

## CORE STRUCTURE DEFINITIONS

### Swing High / Swing Low

- **Swing High**: a high with lower highs on both sides
- **Swing Low**: a low with higher lows on both sides

These require tool-confirmed identification; cannot be inferred.

### BOS — Break of Structure

Valid BOS requires:

- Break of previous swing high/low
- Clear displacement
- Volatility alignment
- HTF bias consistency

BOS confirms trend continuation only if regime is Trend.

### CHOCH — Change of Character

Valid CHOCH requires:

- Opposite-side break of swing level
- Followed by mitigation or meaningful retrace
- Sweep → CHOCH sequence strengthens reversal intent

CHOCH alone does not imply reversal; it is the first signal only.

### Trend Definition

- BOS chain
- Expanding volatility
- HTF alignment
- Pullbacks corrective, continuations impulsive

### Range Definition

- Mixed BOS/CHOCH
- Stable volatility
- Liquidity present at both extremes
- No directional bias until breakout or sweep pattern forms

If structure unclear → classify as Chop regime.

---

## LIQUIDITY FRAMEWORK

### Liquidity Pools

- Prior highs/lows
- Equal highs/lows
- Session highs/lows

These act as magnets and must not be assumed without confirmation.

### Sweep

A valid sweep requires:

- Liquidity taken above/below a known pool
- No invented levels
- Followed by CHOCH for reversal intent
- Without CHOCH → sweep continuation bias

### Equal Highs / Equal Lows

- Represent liquidity buildup
- High-probability sweep targets
- Do not imply reversal by themselves

### Premium / Discount Zones

- Premium → favour sells
- Discount → favour buys
- Must align with HTF and regime
- Premium/Discount cannot override volatility or session context.

---

## INEFFICIENCY AND DISPLACEMENT

### FVG — Fair Value Gap

- Three-candle imbalance
- Valid in trends and breakouts
- Requires alignment with volatility and regime
- Not valid in chop unless micro-scalp approved

### Displacement

- Strong directional candle
- Must align with volatility expansion
- Confirms intent but does not override session rules

### Breaker Block

- Opposing OB invalidated then reused
- Requires HTF alignment and volatility support

---

## ORDER BLOCK FRAMEWORK

### Bullish Order Block

- Last down candle before upward displacement
- Valid only with structure confirmation
- Requires HTF and session alignment

### Bearish Order Block

- Last up candle before downward displacement

### Mitigation Rules

- Price must return to OB after displacement
- Shallow mitigations preferred (≤50% wick penetration)
- Mid-range OB mitigations are invalid unless regime specifically supports them

Institutional zones must align with:

- Depth quality
- Session
- Volatility regime
- Liquidity context

---

## REGIME CLASSIFICATION (MANDATORY)

**Reference**: AUTO_EXECUTION_CHATGPT_KNOWLEDGE_EMBEDDED.md for master regime list.

**Master Regime List**:
- trending
- ranging
- compression
- expansion
- reversal
- chop

**Invalid for Plans**: chop (unless micro-scalp), volatility_shock, exhaustion

**Note**: Variants (ranging_expansion, compression_expansion, trend_exhaustion, liquidity_coil) are combinations of base regimes. Use base regime name when creating plans.

## VOLATILITY_STATE_CONTEXT (Phase 1.4)

**Reference**: AUTO_EXECUTION_CHATGPT_KNOWLEDGE_EMBEDDED.md for volatility states.

**Advanced Volatility States** (affect SMC strategy selection):
- pre_breakout_tension: Compression before breakout - prioritize breakout strategies
- post_breakout_decay: Momentum fading after breakout - prioritize mean reversion
- fragmented_chop: Choppy conditions - only micro_scalp and mean_reversion_range_scalp
- session_switch_flare: Temporary volatility spike during session transitions - BLOCKS ALL PLANS

**Volatility State Priority:**
1. Check `response.data.volatility_metrics.regime` from `moneybot.analyse_symbol_full`
2. If advanced volatility state detected → follow volatility→strategy mapping
3. If `wait_reason` present → DO NOT create plan
4. Volatility state overrides regime classification for strategy selection

**Volatility State Impact on SMC:**
- PRE_BREAKOUT_TENSION: Favor breakout strategies (breakout_ib_volatility_trap, liquidity_sweep_reversal, breaker_block)
- POST_BREAKOUT_DECAY: Favor mean reversion strategies (mean_reversion_range_scalp, fvg_retracement, order_block_rejection)
- FRAGMENTED_CHOP: Only micro_scalp and mean_reversion_range_scalp allowed
- SESSION_SWITCH_FLARE: All SMC strategies blocked - wait for stabilization

### Trend Regime

- BOS chain
- Expanding volatility
- HTF alignment

**Valid Setups:**
- Continuation OB
- FVG continuation
- Breaker continuation

**Invalid Setups:**
- Reversals
- Mean reversion

**Volatility State Context:**
- PRE_BREAKOUT_TENSION: Valid (compression before trend continuation)
- POST_BREAKOUT_DECAY: Invalid (momentum fading - avoid continuation)
- FRAGMENTED_CHOP: Invalid (choppy conditions - no clear trend)
- SESSION_SWITCH_FLARE: Invalid (blocks all plans)

### Range Regime

- Mixed BOS/CHOCH
- Stable volatility

**Valid:**
- Mean reversion
- VWAP reversions
- Range sweeps

**Invalid:**
- Trend continuation

**Volatility State Context:**
- PRE_BREAKOUT_TENSION: Invalid (compression suggests breakout, not range)
- POST_BREAKOUT_DECAY: Valid (momentum fading - mean reversion works)
- FRAGMENTED_CHOP: Valid (only micro_scalp and mean_reversion_range_scalp)
- SESSION_SWITCH_FLARE: Invalid (blocks all plans)

### Breakout Regime

- Expanding volatility
- Displacement from compression

**Valid:**
- Momentum continuation
- Breakout traps

**Invalid:**
- Slow mitigations
- Mean reversion

**Volatility State Context:**
- PRE_BREAKOUT_TENSION: Valid (compression before breakout - ideal setup)
- POST_BREAKOUT_DECAY: Invalid (breakout already occurred, momentum fading)
- FRAGMENTED_CHOP: Invalid (choppy conditions - no clean breakout)
- SESSION_SWITCH_FLARE: Invalid (blocks all plans)

### Compression Regime

- Inside bars
- Contracting volatility

**Valid:**
- Breakout traps
- Sweep of compression extremes

**Volatility State Context:**
- PRE_BREAKOUT_TENSION: Valid (compression confirmed - breakout imminent)
- POST_BREAKOUT_DECAY: Invalid (breakout already occurred)
- FRAGMENTED_CHOP: Invalid (choppy conditions - not clean compression)
- SESSION_SWITCH_FLARE: Invalid (blocks all plans)

### Reversal Regime

- Sweep → CHOCH → mitigation

**Valid:**
- OB reversals
- Breaker reversals
- FVG reversals

### Chop / Micro-Scalp Regime

- Alternating CHOCHs
- Stable volatility

**Valid:**
- VWAP micro-scalps
- Liquidity sweep scalps

**Invalid:**
- Continuation or breakout setups

**Volatility State Context:**
- PRE_BREAKOUT_TENSION: Invalid (compression suggests breakout, not chop)
- POST_BREAKOUT_DECAY: Valid (momentum fading - mean reversion works)
- FRAGMENTED_CHOP: Valid (only micro_scalp and mean_reversion_range_scalp)
- SESSION_SWITCH_FLARE: Invalid (blocks all plans)

---

## STRATEGY SELECTION (MUST FOLLOW PRL)

**CRITICAL**: Strategy selection must consider BOTH market regime AND volatility state.

**Selection Process:**
1. Classify market regime (trending, ranging, compression, etc.)
2. Check volatility state from `response.data.volatility_metrics.regime`
3. Check strategy selection: `response.data.strategy_selection` (top-level convenience field) OR `response.data.volatility_regime.strategy_selection` (nested) for selected strategy and all scores
4. If advanced volatility state → follow volatility→strategy mapping (overrides regime-based selection)
5. If `wait_reason` present (in `strategy_selection.wait_reason` or `strategy_recommendations.wait_reason`) → DO NOT create plan

### Trend Regime Strategies

- Continuation pullback (OB / FVG)
- Momentum continuation
- Breaker continuation

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: Prioritize breakout_ib_volatility_trap, liquidity_sweep_reversal
- POST_BREAKOUT_DECAY: BLOCKED (avoid trend_continuation_pullback)
- FRAGMENTED_CHOP: BLOCKED (only micro_scalp allowed)
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

### Range Regime Strategies

- Mean reversion
- VWAP reversion
- Liquidity sweeps
- Range boundary OB fades

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: BLOCKED (compression suggests breakout, not range)
- POST_BREAKOUT_DECAY: Prioritize mean_reversion_range_scalp, fvg_retracement
- FRAGMENTED_CHOP: Only micro_scalp and mean_reversion_range_scalp allowed
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

### Breakout Regime Strategies

- Momentum expansion
- Breakout trap (fakeout → continuation)

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: Prioritize breakout_ib_volatility_trap (ideal setup)
- POST_BREAKOUT_DECAY: BLOCKED (breakout already occurred)
- FRAGMENTED_CHOP: BLOCKED (choppy conditions)
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

### Compression Regime Strategies

- Inside-bar trap
- Compression sweep
- Breakout preparation

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: Prioritize breakout_ib_volatility_trap (compression confirmed)
- POST_BREAKOUT_DECAY: BLOCKED (breakout already occurred)
- FRAGMENTED_CHOP: BLOCKED (not clean compression)
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

### Reversal Regime Strategies

- Sweep → CHOCH → mitigation entry
- Breaker reversal
- FVG reversal

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: Prioritize liquidity_sweep_reversal, breaker_block
- POST_BREAKOUT_DECAY: Prioritize fvg_retracement, order_block_rejection
- FRAGMENTED_CHOP: BLOCKED (only micro_scalp allowed)
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

### Chop Regime Strategies

- VWAP micro-scalps only
- Small OB/MR scalps only

**Volatility State Override:**
- PRE_BREAKOUT_TENSION: BLOCKED (compression suggests breakout)
- POST_BREAKOUT_DECAY: Prioritize mean_reversion_range_scalp
- FRAGMENTED_CHOP: Only micro_scalp and mean_reversion_range_scalp allowed
- SESSION_SWITCH_FLARE: BLOCKED (all strategies blocked)

---

## CONFLUENCE PRIORITY (STRICT ORDER)

1. Regime correctness
2. Volatility alignment
3. HTF bias
4. Structural validity (BOS/CHOCH)
5. Liquidity context (sweeps, pools, equal highs/lows)
6. OB / FVG quality
7. Session alignment
8. Momentum and volatility slope
9. Location in premium/discount

### Setup Grading

- **All 9** → A+
- **≥5** → acceptable with caution
- **<5** → invalid

---

## SESSION BEHAVIOUR FOR SMC

### Asian

- Mean reversion
- VWAP scalps
- Accumulation behaviour

### London Open

- High sweep probability
- Trap-based setups preferred

### London Session

- Expansion and continuation phase

### New York Open

- High volatility
- Continuation or sweep-reversal setups

### New York Session

- Strong expansions or end-of-day reversals

Session behaviour must align with strategy and volatility.

---

## VALIDATION RULES (STRICT)

A setup is invalid if:

- Regime does not match strategy
- Volatility not aligned with regime
- No valid BOS, CHOCH, or sweep
- Mid-range entry
- OB/FVG misaligned with HTF bias
- Conflicting structure, liquidity, or session signals
- Breakout attempted without volatility expansion
- MR attempted during expansion regime

If structure unclear + stable volatility → classify as Chop regime.

Only micro-scalps allowed until clarity returns.

---

## CONDITION_PARAMETER_REQUIREMENTS

When creating SMC-based auto-execution plans, ChatGPT must include appropriate condition fields based on the SMC pattern detected.

**Order Block Conditions:**
- Required fields: order_block indicator, order_block_type, price_near, tolerance
- Purpose: Confirms price is at an order block zone before entry
- Behavioral rule: Order block plans must explicitly confirm the order block, not just price level

**CHOCH Conditions:**
- Required fields: choch_bull or choch_bear indicator, timeframe, price_near, tolerance
- Purpose: Confirms structure change (CHOCH) has occurred at the specified timeframe
- Behavioral rule: CHOCH plans require both structure confirmation AND price proximity

**FVG Conditions:**
- Required fields: fvg_bull or fvg_bear indicator, fvg_filled_pct (typically 0.5-0.75), choch confirmation, price_near, tolerance
- Purpose: Confirms FVG is being filled and structure supports the direction
- Behavioral rule: FVG plans need fill percentage AND structure confirmation

**Liquidity Sweep Conditions:**
- Required fields: liquidity_sweep indicator, price_below or price_above, timeframe
- Purpose: Detects when liquidity is swept, triggering the plan
- Behavioral rule: Sweep plans must detect the sweep event, not just price reaching a level

**Breaker Block Conditions:**
- Required fields: breaker_block indicator (set to true), price_near, tolerance
- Detection flags (ob_broken, price_retesting_breaker) are checked dynamically by DetectionSystemManager, NOT stored in conditions
- Purpose: Confirms order block was broken and price is retesting the flipped level
- Behavioral rule: Breaker block plans require multiple confirmations (broken OB + retest)

**MSS Conditions:**
- Required fields: mss_bull or mss_bear indicator, pullback_to_mss confirmation, price_near, tolerance
- Purpose: Confirms market structure shift and pullback to confirm the shift
- Behavioral rule: MSS plans require both structure shift AND pullback confirmation

---

# END_OF_DOCUMENT
