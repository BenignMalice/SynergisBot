# ADAPTIVE AUTO-EXECUTION FEATURES GUIDE

## ⚠️⚠️⚠️ CRITICAL: MULTI-LEVEL ENTRY EXECUTION BEHAVIOR - READ THIS FIRST ⚠️⚠️⚠️

**MANDATORY UNDERSTANDING - DO NOT SKIP:**

When a plan has `entry_levels` (multiple entry levels), the execution behavior is:

1. **SINGLE EXECUTION:** Plan executes ONCE when the FIRST level in the array enters its tolerance zone
2. **FULL VOLUME:** The FULL plan volume executes at that triggered level (NOT partial fills, NOT proportional to weight)
3. **STOPS MONITORING:** After execution, the plan STOPS monitoring - it does NOT continue watching other levels
4. **WEIGHT IGNORED:** The `weight` field is NOT used for volume allocation in Phase 2 - full volume executes regardless

**❌ WRONG DESCRIPTIONS (NEVER USE THESE):**
- "Each level executes independently" → ❌ WRONG
- "Partial fills proportional to weight" → ❌ WRONG
- "Scales in automatically as price reaches each zone" → ❌ WRONG
- "If price hits level 1, you're 50% filled. If it later dips into level 2, it fills another 30%" → ❌ WRONG
- "Each entry uses its defined weight to size the position" → ❌ WRONG
- "Once all defined levels are executed, the plan is marked complete" → ❌ WRONG

**✅ CORRECT DESCRIPTION:**
- "Plan executes ONCE when first level enters zone, with FULL volume at that level"
- "Single execution, not multiple"
- "Plan stops monitoring after execution"
- "Weight is not used for volume allocation"

**EXAMPLE:**
If you have 3 entry levels with weights [0.5, 0.3, 0.2] and plan volume 0.01:
- ❌ WRONG: "Level 1 executes 0.005 lots (50%), level 2 executes 0.003 lots (30%), level 3 executes 0.002 lots (20%)"
- ✅ CORRECT: "When level 1 enters zone, FULL 0.01 lots executes at level 1. Plan stops. Levels 2 and 3 are never executed."

---

## PURPOSE
Comprehensive guide to all adaptive auto-execution plan features (Phase 1-4). This document covers tolerance zone execution, multi-level entry strategy, conditional cancellation, and plan re-evaluation. Use this guide when creating, managing, and monitoring auto-execution plans.

---

# PART 1: TOLERANCE ZONE EXECUTION

## TOLERANCE_ZONE_DEFINITION

tolerance_zone:
  - definition: Execution zone around entry_price defined by tolerance parameter
  - formula: entry_price ± tolerance
  - zone_bounds:
    - lower_bound: entry_price - tolerance
    - upper_bound: entry_price + tolerance
  - execution_rule:
    - BUY: Execute when price is at or below (entry_price + tolerance)
    - SELL: Execute when price is at or above (entry_price - tolerance)
  - zone_entry_detection:
    - system_tracks: Whether price is currently in zone
    - entry_detected: When price transitions from outside zone to inside zone
    - re_entry: If price exits zone before execution, plan retries on re-entry

## ZONE_ENTRY_DETECTION

zone_entry_logic:
  - detection_method: Compare current price to zone bounds
  - previous_state: System tracks previous zone state (in_zone/out_of_zone)
  - entry_trigger: Transition from out_of_zone to in_zone
  - execution_behavior:
    - execute_once: Plan executes once when entering zone (not continuously)
    - retry_on_re_entry: If price exits and re-enters, plan can retry
  - state_tracking:
    - zone_entry_tracked: Boolean flag indicating if entry was detected
    - zone_entry_time: Timestamp when price first entered zone
    - zone_exit_time: Timestamp when price exited zone (if applicable)

## EXECUTION_BEHAVIOR

execution_rules:
  - single_execution: Plan executes once when zone entry is detected
  - not_continuous: Plan does NOT execute continuously while price remains in zone
  - re_entry_handling:
    - if_price_exits: Plan remains active, can retry on re-entry
    - if_price_re_enters: Zone entry is detected again, plan can execute
  - zone_state_persistence:
    - zone_entry_tracked: Persisted to database
    - zone_entry_time: Persisted to database
    - zone_exit_time: Persisted to database (if applicable)

## TOLERANCE_RECOMMENDATIONS

tolerance_guidelines:
  - BTCUSDc:
    - range: 0.1-0.3% (100-300 points)
    - rationale: Higher volatility requires wider tolerance
    - example: Entry 50000, tolerance 100 → Zone: 49900-50100
  - XAUUSDc:
    - range: 0.05-0.15% (2-7 points)
    - rationale: Moderate volatility
    - example: Entry 2000, tolerance 5 → Zone: 1995-2005
  - Forex_pairs:
    - EURUSD_GBPUSD_USDJPY: 0.02-0.05% (2-5 pips)
    - rationale: Lower volatility, tighter tolerance
    - example: Entry 1.1000, tolerance 0.0003 → Zone: 1.0997-1.1003
  - auto_calculation:
    - if_tolerance_omitted: System auto-calculates based on symbol type
    - calculation_method: Uses symbol-specific volatility characteristics

## TOLERANCE_BEST_PRACTICES

tolerance_selection:
  - wider_tolerance_when:
    - high_volatility: Symbol has high ATR or recent volatility spikes
    - price_may_bounce: Market conditions suggest price may bounce around entry
    - range_trading: Trading in ranging/consolidation markets
    - news_events: Near high-impact news events (wider tolerance for slippage)
  - narrower_tolerance_when:
    - stable_markets: Low volatility, stable market conditions
    - precise_entries: Strategy requires precise entry (e.g., order block rejection)
    - tight_stops: Stop loss is tight, need precise entry for R:R
    - low_volatility: ATR is low, market is quiet
  - symbol_specific:
    - always_consider: Symbol volatility characteristics
    - BTCUSDc: Default wider (100-300 points)
    - XAUUSDc: Default moderate (2-7 points)
    - Forex: Default tighter (2-5 pips)

## TOLERANCE_COMMON_MISTAKES

mistakes_to_avoid:
  - overly_tight_tolerance:
    - mistake: Using tolerance too small (e.g., 10 points for BTC)
    - consequence: Plan may never execute if price bounces around entry
    - fix: Use recommended ranges based on symbol volatility
  - misunderstanding_zone:
    - mistake: Thinking tolerance is exact price match
    - consequence: Confusion about when plan will execute
    - fix: Understand tolerance creates a zone, not exact price
  - missing_tolerance:
    - mistake: Not including tolerance in conditions
    - consequence: System uses default, may not match strategy needs
    - fix: Always include tolerance in conditions dict
  - wrong_direction_logic:
    - mistake: Using same tolerance logic for BUY and SELL
    - consequence: Plans may execute at wrong price
    - fix: BUY executes at/below (entry + tolerance), SELL at/above (entry - tolerance)

---

# PART 2: MULTI-LEVEL ENTRY STRATEGY

## ⚠️⚠️⚠️ CRITICAL: EXECUTION BEHAVIOR - READ FIRST ⚠️⚠️⚠️

**MANDATORY UNDERSTANDING - DO NOT SKIP THIS SECTION:**

execution_behavior_critical:
  - what_happens: "Plan executes ONCE when FIRST level in array enters tolerance zone"
  - execution_count: "ONE execution total - NOT one per level, NOT multiple times"
  - volume_behavior: "FULL plan volume executes at the triggered level"
  - partial_fills: "NO partial fills in Phase 2 - full volume executes regardless of weight"
  - weight_purpose: "Weight field is NOT used for volume allocation - it's reserved for future use"
  - monitoring_behavior: "After execution, plan STOPS monitoring - does NOT continue watching other levels"
  - level_independence: "Levels are NOT independent - plan executes once at first level that triggers"
  
forbidden_descriptions_NEVER_USE_THESE_WORDS:
  - ❌ "partial positions" or "partial fills" or "partial entries"
  - ❌ "each level executes independently" or "each level acts as a micro-plan" or "each level acts as a sub-plan"
  - ❌ "proportional volume" or "weight controls volume allocation" or "weight determines volume"
  - ❌ "multiple executions" or "executes when its price zone is reached" (plural) or "executes when price reaches each zone"
  - ❌ "scales in automatically" or "additional volume is added" or "scales in gradually"
  - ❌ "executed_weight, pending_weight" or "records progress" or "tracks progress"
  - ❌ "monitored separately" or "monitors them independently" or "monitored independently"
  - ❌ "that portion executes" or "proportional sizing" or "layered entries with proportional sizing"
  - ❌ "If price retraces and hits another level, additional volume is added"
  - ❌ "The system will scale in automatically as price reaches each zone"
  - ❌ "Each level is monitored separately, executes when its price zone is reached"
  
correct_descriptions_ALWAYS_USE_THESE:
  - ✅ "Plan executes ONCE when first level enters zone"
  - ✅ "Full volume executes at triggered level"
  - ✅ "Single execution, not multiple"
  - ✅ "Plan stops monitoring after execution"
  - ✅ "Weight is not used for volume allocation"
  
example_correct_explanation:
  - text: "A multi-level entry plan has multiple price levels, but executes ONCE when the FIRST level enters its tolerance zone. The FULL plan volume executes at that triggered level. After execution, the plan stops monitoring. Weight is optional but not used for volume allocation in Phase 2."

## ❌ WRONG vs ✅ CORRECT - DIRECT COMPARISON

wrong_vs_correct_examples:
  - wrong: "partial positions may be entered automatically"
    correct: "FULL position executes ONCE when first level enters zone"
  - wrong: "Each level acts as a micro-plan under the parent plan"
    correct: "Single plan with multiple entry levels - executes once at first level"
  - wrong: "When price enters the tolerance zone of a level, that portion executes"
    correct: "When FIRST level enters zone, FULL volume executes at that level"
  - wrong: "If price retraces and hits another level, additional volume is added proportionally"
    correct: "Plan executes ONCE and stops - does NOT add additional volume"
  - wrong: "The system records progress (executed_weight, pending_weight)"
    correct: "System executes once and marks plan as executed - no progress tracking"
  - wrong: "Each level is monitored separately, executes when its price zone is reached"
    correct: "Plan monitors all levels but executes ONCE when first level enters zone"
  - wrong: "scales in automatically as price reaches each zone"
    correct: "Executes once at first level - does NOT scale in"
  - wrong: "layered entries with proportional sizing"
    correct: "Multiple entry levels but single execution with full volume"

## WHEN_TO_USE_MULTIPLE_LEVELS

use_cases:
  - order_block_zones:
    - scenario: Multiple order block levels detected (e.g., M1, M5, H1 OBs at different prices)
    - example: BTCUSDc has OBs at 50000, 50100, 50200 - create plan with 3 levels
    - rationale: Price may not reach exact OB level, but may hit nearby OB zones
  - liquidity_sweep_areas:
    - scenario: Liquidity sweep + retest levels
    - example: Sweep at 49900, retest at 50000 - create plan with 2 levels
    - rationale: Capture both sweep entry and retest entry
  - range_boundaries:
    - scenario: Support + resistance levels in ranging market
    - example: Support at 49800, resistance at 50200 - create BUY plan at support, SELL plan at resistance
    - rationale: Price may bounce at either boundary
  - trend_continuation:
    - scenario: Pullback + breakout levels
    - example: Pullback at 50000, breakout at 50100 - create plan with 2 levels
    - rationale: Capture pullback entry or breakout entry
  - fibonacci_levels:
    - scenario: Multiple Fibonacci retracement levels
    - example: 38.2% at 50000, 50% at 49900, 61.8% at 49800 - create plan with 3 levels
    - rationale: Price may react at any Fibonacci level

## ⚠️⚠️⚠️ CRITICAL EXECUTION BEHAVIOR - READ FIRST ⚠️⚠️⚠️

execution_behavior_critical:
  - single_execution_only: "Plan executes ONCE when FIRST level enters tolerance zone - NOT multiple times"
  - full_volume_at_triggered_level: "FULL plan volume executes at the triggered level - NO partial fills in Phase 2"
  - weight_not_used: "Weight field is NOT used for volume allocation - full volume executes regardless of weight value"
  - stops_after_execution: "After execution, plan stops monitoring - does NOT continue watching other levels"
  - incorrect_understanding: "DO NOT describe as 'partial fills', 'multiple executions', 'proportional volume', or 'each level executes independently'"
  - correct_understanding: "Single plan, single execution, full volume at first level that enters zone"

## MULTI_LEVEL_PLAN_STRUCTURE

entry_levels_structure:
  - format: Array of objects
  - required_fields:
    - price: float (required) - Entry price for this level
  - optional_fields:
    - weight: float (optional, default 1.0) - Level weight (for future partial fills)
    - sl_offset: float (optional) - Stop loss offset from level price
    - tp_offset: float (optional) - Take profit offset from level price
  - example:
    - level_1:
      - price: 49900.0
      - weight: 1.0
      - sl_offset: 500.0
      - tp_offset: 1000.0
    - level_2:
      - price: 50000.0
      - weight: 1.0
      - sl_offset: 600.0
      - tp_offset: 1200.0
    - level_3:
      - price: 50100.0
      - weight: 1.0
      - sl_offset: 500.0
      - tp_offset: 1000.0

## ⚠️ CRITICAL: CORRECT STRUCTURE REQUIREMENTS

structure_warnings:
  - correct_format:
    - field_name: "price" (NOT "entry")
    - field_name: "sl_offset" (NOT "stop_loss")
    - field_name: "tp_offset" (NOT "take_profit")
    - no_tolerance_per_level: Tolerance is at PLAN level (in conditions), NOT in entry_levels objects
    - no_volume_per_level: Volume is at PLAN level, NOT in entry_levels objects
  - correct_example:
    - json: '[{"price": 50000, "sl_offset": 300, "tp_offset": 600}, {"price": 50100, "sl_offset": 300, "tp_offset": 600}]'
    - explanation: "Each level has price and offsets, tolerance/volume are at plan level"
  - incorrect_examples:
    - wrong_1: '[{"entry": 50000, "stop_loss": 51000, "take_profit": 49000}]'
      error: "Uses 'entry' instead of 'price', uses absolute SL/TP instead of offsets"
    - wrong_2: '[{"price": 50000, "tolerance": 150, "volume": 0.01}]'
      error: "Tolerance and volume should NOT be in entry_levels - they belong at plan level"
    - wrong_3: '[{"entry": 50000, "stop_loss": 51000, "take_profit": 49000, "tolerance": 150, "volume": 0.01}]'
      error: "All fields are wrong - this structure will be rejected by the system"
  - validation_rules:
    - system_will_reject: "Any entry_levels object containing 'entry', 'stop_loss', 'take_profit', 'tolerance', or 'volume' fields"
    - system_requires: "Each level must have 'price' field (required)"
    - system_accepts: "Optional fields: 'weight', 'sl_offset', 'tp_offset'"

## MULTI_LEVEL_EXECUTION_LOGIC

execution_rules:
  - priority_order: Array order determines priority (first level in array = first to check)
  - first_level_triggers: Plan executes when first level enters tolerance zone
  - single_execution: Plan executes ONCE when first level enters zone (not multiple times for each level)
  - full_volume_at_triggered_level: Full plan volume executes at the triggered level (weight is optional and NOT used for volume allocation in Phase 2)
  - no_partial_fills: Phase 2 does NOT support partial fills - plan executes once with full volume
  - weight_field_purpose: Weight field exists but is NOT used for volume allocation in Phase 2 (reserved for future partial fill support)
  - triggered_level_sl_tp:
    - if_offsets_provided: Uses triggered level's SL/TP offsets
    - if_no_offsets: Uses plan's base SL/TP
    - calculation:
      - BUY: SL = level_price - sl_offset, TP = level_price + tp_offset
      - SELL: SL = level_price + sl_offset, TP = level_price - tp_offset
  - level_index_tracking: System tracks which level triggered execution (for logging/analysis)
  - execution_behavior_clarification:
    - NOT: "Each level executes independently with proportional volume"
    - NOT: "Plan continues watching other levels after first execution"
    - CORRECT: "Plan executes ONCE when first level enters zone, with full volume at that level"
    - CORRECT: "After execution, plan is marked as executed and stops monitoring"

## MULTI_LEVEL_SL_TP_CALCULATION

sl_tp_logic:
  - base_plan_sl_tp: Used if level offsets not provided
  - level_specific_sl_tp:
    - if_sl_offset_provided: Calculate from level price
    - if_tp_offset_provided: Calculate from level price
    - if_both_provided: Use both offsets
    - if_neither_provided: Use base plan SL/TP
  - calculation_examples:
    - buy_level_example:
      - level_price: 50000.0
      - sl_offset: 500.0
      - tp_offset: 1000.0
      - calculated_sl: 50000.0 - 500.0 = 49500.0
      - calculated_tp: 50000.0 + 1000.0 = 51000.0
    - sell_level_example:
      - level_price: 50000.0
      - sl_offset: 500.0
      - tp_offset: 1000.0
      - calculated_sl: 50000.0 + 500.0 = 50500.0
      - calculated_tp: 50000.0 - 1000.0 = 49000.0

## MULTI_LEVEL_PRIORITY

priority_rules:
  - array_order: First level in array is checked first
  - first_to_enter_zone: First level that enters tolerance zone triggers execution
  - overlapping_zones: If multiple levels' zones overlap, first in array order wins
  - sorting:
    - auto_sort: Levels are auto-sorted by price (ascending for BUY, descending for SELL)
    - manual_order: Can override by providing levels in desired priority order
  - best_practice: Place most important/expected level first in array

## MULTI_LEVEL_BEST_PRACTICES

recommendations:
  - number_of_levels:
    - recommended: 2-3 levels
    - maximum: 10 levels (system enforced)
    - rationale: Too many levels can cause confusion and reduce effectiveness
  - level_spacing:
    - minimum: Levels should be at least 50% of tolerance apart
    - recommended: 1-2x tolerance spacing for clear separation
    - validation: System rejects levels too close together
  - meaningful_levels:
    - requirement: Levels should be based on technical analysis (OB, support/resistance, Fibonacci, etc.)
    - avoid: Arbitrary prices without technical basis
    - rationale: Meaningful levels have higher probability of execution
  - offset_calculation:
    - if_custom_rr: Provide sl_offset and tp_offset for each level
    - if_same_rr: Can omit offsets, system uses base plan SL/TP
    - recommendation: Calculate offsets based on level price and desired R:R ratio

## MULTI_LEVEL_COMMON_MISTAKES

mistakes_to_avoid:
  - misunderstanding_execution:
    - mistake: Thinking plan executes multiple times (once for each level) or that weight controls volume allocation
    - consequence: Incorrect expectations about execution behavior - plan will only execute once, not multiple times
    - fix: Plan executes ONCE when first level enters zone, with full volume at that level. Weight is NOT used for volume allocation in Phase 2. After execution, plan stops monitoring.
  - too_many_levels:
    - mistake: Creating plans with 5+ levels
    - consequence: Confusion, reduced effectiveness, harder to manage
    - fix: Limit to 2-3 levels, focus on most important setups
  - overlapping_levels:
    - mistake: Levels too close together (within 50% of tolerance)
    - consequence: System rejects or levels compete unnecessarily
    - fix: Space levels at least 1x tolerance apart
  - arbitrary_prices:
    - mistake: Using random prices without technical basis
    - consequence: Lower probability of execution, poor R:R
    - fix: Base levels on technical analysis (OB, support/resistance, Fibonacci, etc.)
  - missing_offsets:
    - mistake: Not providing sl_offset/tp_offset when levels have different R:R needs
    - consequence: All levels use same SL/TP, may not match level-specific risk
    - fix: Calculate offsets based on each level's price and desired R:R
  - wrong_priority_order:
    - mistake: Placing less important level first in array
    - consequence: Plan may execute at less optimal level
    - fix: Place most important/expected level first in array

---

# PART 3: CONDITIONAL CANCELLATION

## ⚠️⚠️⚠️ CRITICAL: WHAT CANCELLATION CONDITIONS ARE ACTUALLY IMPLEMENTED ⚠️⚠️⚠️

**MANDATORY READING BEFORE DESCRIBING CANCELLATION:**

**✅ ONLY THESE TWO CONDITIONS ARE FULLY IMPLEMENTED:**
1. **Price Distance Cancellation** - Price moves beyond threshold percentage away from entry
2. **Time-Based Cancellation** - Plan is old (>24h) AND price hasn't approached entry (>0.3% away)

**❌ DO NOT MENTION THESE AS ACTIVE CANCELLATION CONDITIONS (THEY ARE NOT IMPLEMENTED):**
- ❌ "Session Switch Flare" or "session transition cancellation" - NOT IMPLEMENTED
- ❌ "News blackout" or "high-impact event cancellation" - NOT IMPLEMENTED
- ❌ "Volatility regime changes" or "volatility-structure alignment cancellation" - DISABLED in config
- ❌ "Symbol constraint breach" or "max concurrent trades exceeded" - NOT IMPLEMENTED
- ❌ "CHOCH/BOS invalidation cancellation" - NOT IMPLEMENTED (structure cancellation is placeholder only)
- ❌ "Server restart cleanup" - NOT IMPLEMENTED
- ❌ "Duplicate plan detection" - NOT IMPLEMENTED
- ❌ "Data integrity failure cancellation" - NOT IMPLEMENTED

**⚠️ PLACEHOLDER CONDITIONS (ENABLED BUT NOT WORKING):**
- Structure cancellation - enabled but placeholder (TODO: integrate with multi_timeframe_analyzer)
- Condition invalidation - enabled but simplified (TODO: implement full validation)

**WHEN DESCRIBING CANCELLATION RISK:**
- ✅ DO mention: Price distance from entry, time since plan creation, expiry time remaining
- ❌ DO NOT mention: Session switches, news events, volatility regime changes, symbol constraints, structure breaks, CHOCH/BOS invalidation

---

## WHEN_PLANS_ARE_CANCELLED

**⚠️ IMPLEMENTATION STATUS:** Only the following cancellation conditions are currently implemented. Other conditions mentioned in some documentation are NOT yet implemented.

cancellation_conditions:
  - price_distance_cancellation:
    - status: ✅ **FULLY IMPLEMENTED**
    - condition: Price moves beyond threshold percentage away from entry
    - thresholds:
      - BTCUSDc: 0.5% (default)
      - XAUUSDc: 0.3%
      - EURUSD: 0.2%
      - GBPUSD: 0.2%
      - USDJPY: 0.2%
      - default: 0.5%
    - rationale: If price moves too far, entry setup is no longer valid
    - priority: medium
    - check_interval: Every 5 minutes (configurable in config/auto_execution_adaptive_config.json)
  - time_based_cancellation:
    - status: ✅ **FULLY IMPLEMENTED**
    - condition: Plan is old (>24h) AND price hasn't approached entry (>0.3% away)
    - rationale: Old plans that haven't triggered are likely invalid
    - priority: low
    - max_age_hours: 24 (configurable)
    - price_distance_threshold: 0.3% (configurable)
  - structure_cancellation:
    - status: ⚠️ **ENABLED BUT PLACEHOLDER** (TODO: integrate with multi_timeframe_analyzer)
    - condition: Market structure invalidates setup (support/resistance broken)
    - rationale: If key structure levels are broken, setup context has changed
    - priority: high
    - check_interval: Every 60 minutes (configurable)
    - note: Currently a placeholder - structure checks not yet implemented. Do NOT describe this as actively cancelling plans.
  - condition_invalidation:
    - status: ⚠️ **ENABLED BUT SIMPLIFIED** (TODO: implement full validation)
    - condition: Original conditions become impossible
    - examples:
      - Order block plan: Order block invalidated (TODO: full validation)
      - Liquidity sweep plan: Sweep already occurred (TODO: sweep detection)
    - rationale: If conditions can't be met, plan will never execute
    - priority: high
    - check_interval: Every 15 minutes (configurable)
    - note: Currently simplified - full condition validation not yet implemented. Do NOT describe specific condition checks as active.

## NOT_IMPLEMENTED_CANCELLATION_CONDITIONS

**⚠️ CRITICAL:** The following cancellation conditions are NOT implemented. Do NOT describe these as active features:

not_implemented:
  - session_switch_cancellation:
    - status: ❌ NOT IMPLEMENTED
    - description: "Session switch flare" or "session transition cancellation"
    - note: Do NOT mention this as an active cancellation condition
  - news_blackout_cancellation:
    - status: ❌ NOT IMPLEMENTED
    - description: "News blackout" or "high-impact event cancellation"
    - note: Do NOT mention this as an active cancellation condition
  - volatility_structure_alignment:
    - status: ❌ NOT IMPLEMENTED (disabled in config)
    - description: "Invalid volatility–structure alignment cancellation"
    - note: volatility_cancellation is disabled in config/auto_execution_adaptive_config.json
  - symbol_constraint_breach:
    - status: ❌ NOT IMPLEMENTED
    - description: "Symbol constraint breach" or "max concurrent trades exceeded"
    - note: Do NOT mention this as an active cancellation condition
  - choch_bos_invalidation:
    - status: ❌ NOT IMPLEMENTED
    - description: "CHOCH/BOS signal invalidated" cancellation
    - note: Structure cancellation is placeholder only - do NOT describe CHOCH/BOS invalidation as active
  - server_restart_cleanup:
    - status: ❌ NOT IMPLEMENTED
    - description: "Server/database restart cleanup"
    - note: Do NOT mention this as an active cancellation condition
  - duplicate_plan_detection:
    - status: ❌ NOT IMPLEMENTED
    - description: "Duplicate or conflicting plan detection"
    - note: Do NOT mention this as an active cancellation condition
  - data_integrity_failure:
    - status: ❌ NOT IMPLEMENTED
    - description: "Tool or data integrity failure cancellation"
    - note: Do NOT mention this as an active cancellation condition

## CANCELLATION_PRIORITY

priority_levels:
  - high:
    - conditions: Condition invalidation, structure cancellation
    - behavior: Cancel immediately - conditions are impossible
    - risk_score: 1.0
  - medium:
    - conditions: Price distance cancellation
    - behavior: Cancel if price doesn't recover - may still be valid
    - risk_score: 0.7
  - low:
    - conditions: Time-based cancellation
    - behavior: Cancel if price doesn't approach - may still be valid
    - risk_score: 0.4

## CHECKING_CANCELLATION_STATUS

api_usage:
  - tool: moneybot.get_auto_plan_status
  - response_fields:
    - cancellation_risk: float (0-1) - Risk of plan being cancelled
    - cancellation_reasons: array of strings - Potential cancellation reasons
    - cancellation_priority: string (high/medium/low) - Priority if cancellation pending
    - cancellation_reason: string - Reason if plan was cancelled
    - last_cancellation_check: string - Timestamp of last cancellation check
  - interpretation:
    - risk_0_0_0_3: Low risk - plan is healthy
    - risk_0_3_0_7: Moderate risk - monitor plan closely
    - risk_0_7_0_8: High risk - plan may be cancelled soon
    - risk_0_8_1_0: Very high risk - cancellation likely imminent

## ⚠️⚠️⚠️ FORBIDDEN PHRASES WHEN DESCRIBING CANCELLATION RISK ⚠️⚠️⚠️

**DO NOT USE THESE PHRASES (They describe unimplemented features):**

❌ **FORBIDDEN:**
- "Session about to switch (London → NYO) → may trigger auto-cancel"
- "Session alignment: Session about to switch → may trigger auto-cancel"
- "Session transition can auto-invalidate inactive plans"
- "Session Switch Flare invalidator can cancel the plan"
- "News blackout: None detected for Gold"
- "News blackout cancellation"
- "High-impact event cancellation"
- "Volatility expansion detected — execution conditions may be re-evaluated"
- "Volatility regime changes trigger invalidation"
- "Volatility regime changes to SESSION_SWITCH_FLARE"
- "Volatility-structure alignment cancellation"
- "Symbol constraint breach cancellation"
- "Max concurrent trades exceeded"
- "CHOCH/BOS invalidation cancellation"
- "Structure breaks trigger cancellation"
- "Support/resistance broken → cancellation"

✅ **CORRECT PHRASES (Only mention implemented conditions):**
- "Price distance cancellation: Currently X.XX% away from entry (threshold: Y.YY%)"
- "Time-based cancellation: Plan is X.X hours old, price is Y.YY% away from entry"
- "Cancellation risk based on: Price distance (X.XX% away, threshold: Y.YY%), Time since creation (X.X hours, max: 24h), Expiry time remaining (X.X hours)"
- "Price moved beyond threshold → cancellation risk: [low/medium/high]"
- "Plan is old (>24h) and price hasn't approached entry (>0.3% away) → cancellation risk: [low/medium/high]"

## CANCELLATION_REASONS

common_reasons:
  - price_distance:
    - message: "Price moved X.XX% away from entry (threshold: Y.YY%)"
    - action: Check if price can recover, consider updating entry if setup still valid
  - time_based:
    - message: "Plan is X.Xh old and price is Y.YY% away from entry"
    - action: Evaluate if setup is still valid, consider creating new plan
  - condition_invalidation:
    - message: "Order block condition invalidated - order block no longer valid"
    - action: Setup is no longer valid, plan should be cancelled
  - structure_cancellation:
    - message: "Market structure invalidates setup (support/resistance broken)"
    - action: Setup context has changed, plan should be cancelled

## CANCELLATION_BEST_PRACTICES

recommendations:
  - monitor_plans:
    - check_cancellation_risk: Periodically check cancellation_risk for pending plans
    - high_risk_plans: If risk >0.8, consider manually cancelling or updating plan
    - review_reasons: Check cancellation_reasons to understand why risk is high
  - plan_creation:
    - appropriate_tolerance: Use appropriate tolerance to avoid premature cancellation
    - reasonable_expiration: Set reasonable expiration times (not too long)
    - valid_conditions: Ensure conditions are still valid when creating plan
  - plan_management:
    - update_if_needed: If cancellation risk is high but setup is still valid, update plan
    - cancel_if_invalid: If setup is invalid, cancel plan rather than waiting for auto-cancellation
    - create_new_if_needed: If plan is cancelled, create new plan if setup is still valid

## CANCELLATION_COMMON_MISTAKES

mistakes_to_avoid:
  - ignoring_cancellation_risk:
    - mistake: Not checking cancellation_risk for pending plans
    - consequence: Plans may be cancelled unexpectedly
    - fix: Periodically check cancellation_risk, especially for long-running plans
  - too_tight_tolerance:
    - mistake: Using very tight tolerance that triggers premature cancellation
    - consequence: Plans cancelled even when setup is still valid
    - fix: Use appropriate tolerance based on symbol volatility
  - too_long_expiration:
    - mistake: Setting very long expiration times (>48h)
    - consequence: Plans may become invalid but not cancelled
    - fix: Use reasonable expiration times (8-24h for most plans)
  - not_updating_invalid_plans:
    - mistake: Keeping plans with high cancellation risk without updating
    - consequence: Plans cancelled when they could be updated
    - fix: Update plans if setup is still valid, cancel if invalid

---

# PART 4: PLAN RE-EVALUATION

## ⚠️⚠️⚠️ CRITICAL: WHAT RE-EVALUATION TRIGGERS ARE ACTUALLY IMPLEMENTED ⚠️⚠️⚠️

**MANDATORY READING BEFORE DESCRIBING RE-EVALUATION:**

**✅ ONLY THESE TWO TRIGGERS ARE FULLY IMPLEMENTED:**
1. **Price Movement Trigger** - Price moves >0.2% from entry (configurable, default 0.2%)
2. **Time-Based Trigger** - Plan age >= 4 hours (configurable, default 4 hours)

**⚠️ PLACEHOLDER TRIGGERS (ENABLED BUT NOT WORKING):**
- Structure change trigger - enabled but placeholder (TODO: integrate with multi_timeframe_analyzer)
- Volatility regime trigger - DISABLED in config (volatility_regime_enabled: false)

**❌ DO NOT MENTION THESE AS ACTIVE RE-EVALUATION TRIGGERS (THEY ARE NOT IMPLEMENTED):**
- ❌ "Session Switch" or "session transition" trigger - NOT IMPLEMENTED
- ❌ "Price Distance Check every 5 minutes" - This is for CANCELLATION, not re-evaluation
- ❌ "Volatility Regime Change" trigger - DISABLED in config
- ❌ "Structural Invalidation" or "structure breaks" trigger - PLACEHOLDER only
- ❌ "Time-Based Re-Eval hourly" - WRONG, it's every 4 hours, not hourly
- ❌ "News Check" or "news blackout" trigger - NOT IMPLEMENTED
- ❌ "Symbol constraint breach" trigger - NOT IMPLEMENTED
- ❌ "CHOCH/BOS invalidation" trigger - NOT IMPLEMENTED

**WHEN DESCRIBING RE-EVALUATION:**
- ✅ DO mention: Price movement (>0.2% from entry), time-based (every 4 hours), cooldown (60 minutes), daily limit (6 per day)
- ❌ DO NOT mention: Session switches, news events, volatility regime changes, structure breaks, hourly checks, 5-minute checks

---

## WHEN_PLANS_ARE_RE_EVALUATED

**⚠️ IMPLEMENTATION STATUS:** Only price_movement and time_based triggers are fully implemented. Structure and volatility triggers are placeholders.

re_evaluation_triggers:
  - price_movement_trigger:
    - status: ✅ **FULLY IMPLEMENTED**
    - condition: Price moves beyond threshold percentage from entry
    - threshold: 0.2% default (configurable in config/auto_execution_adaptive_config.json)
    - rationale: If price moves significantly, entry level may no longer be optimal
    - priority: High (immediate re-evaluation)
    - check_interval: Every 30 minutes (configurable, check_interval_minutes)
  - time_based_trigger:
    - status: ✅ **FULLY IMPLEMENTED**
    - condition: Plan age >= 4 hours (configurable, time_based_trigger_hours)
    - rationale: Market conditions change over time, plans should be reviewed periodically
    - priority: Medium (scheduled re-evaluation)
    - default_interval: 4 hours (configurable)
  - structure_change_trigger:
    - status: ⚠️ **ENABLED BUT PLACEHOLDER** (TODO: integrate with multi_timeframe_analyzer)
    - condition: Key structure levels break (support/resistance)
    - rationale: If market structure changes, plan setup may be invalid
    - priority: High (immediate re-evaluation)
    - note: Currently a placeholder - structure checks not yet implemented. Do NOT describe this as actively triggering re-evaluation.
  - volatility_regime_trigger:
    - status: ❌ **DISABLED** (volatility_regime_enabled: false in config)
    - condition: Volatility regime changes significantly
    - rationale: Plan parameters may need adjustment for new volatility regime
    - priority: Medium (scheduled re-evaluation)
    - note: DISABLED in config - do NOT mention this as an active trigger

## ⚠️⚠️⚠️ FORBIDDEN PHRASES WHEN DESCRIBING RE-EVALUATION ⚠️⚠️⚠️

**DO NOT USE THESE PHRASES (They describe unimplemented features):**

❌ **FORBIDDEN:**
- "Price Distance Check runs every 5 minutes" (This is for CANCELLATION, not re-evaluation)
- "Session Switch trigger" or "session transition re-evaluation"
- "Volatility Regime Change trigger" or "volatility expansion triggers re-evaluation"
- "Structural Invalidation trigger" or "structure breaks trigger re-evaluation"
- "Time-Based Re-Eval hourly" (WRONG - it's every 4 hours, not hourly)
- "News Check" or "news blackout triggers re-evaluation"
- "Symbol constraint breach triggers re-evaluation"
- "CHOCH/BOS invalidation triggers re-evaluation"
- "Re-evaluation frequency: Every 5-60 minutes depending on trigger" (WRONG - only 2 triggers are implemented)
- "Re-evaluation runs every 5 min for BTCUSDc, every 10 min for Forex" (WRONG - check interval is 30 minutes, triggers are price movement and time-based)

✅ **CORRECT PHRASES (Only mention implemented triggers):**
- "Re-evaluation triggers: Price movement (>0.2% from entry) or time-based (every 4 hours)"
- "Price movement trigger: Price moves >0.2% from entry → triggers re-evaluation"
- "Time-based trigger: Plan age >= 4 hours → triggers re-evaluation"
- "Re-evaluation cooldown: 60 minutes between re-evaluations"
- "Daily limit: 6 re-evaluations per plan per day"
- "Re-evaluation check interval: Every 30 minutes (checks if triggers have fired)"

## RE_EVALUATION_ACTIONS

**⚠️ IMPLEMENTATION STATUS:** Currently, re-evaluation always returns "keep" action. Update, cancel_replace, and create_additional actions are placeholders for future implementation.

action_types:
  - keep:
    - status: ✅ **FULLY IMPLEMENTED**
    - condition: Plan conditions still valid, entry level still optimal
    - behavior: No changes needed, plan continues as-is
    - frequency: Most common action
  - update:
    - condition: Small adjustments needed (<0.1% entry price change)
    - behavior: Adjust entry price, SL/TP, or tolerance based on new structure
    - frequency: Occasional
    - status: Framework ready (implementation pending)
  - cancel_replace:
    - condition: Original setup invalid, better setup available
    - behavior: Cancel old plan, create new plan with updated analysis
    - frequency: Rare
    - status: Framework ready (implementation pending)
  - create_additional:
    - condition: Original plan still valid, new opportunity detected
    - behavior: Create complementary plan alongside existing plan
    - frequency: Rare
    - status: Framework ready (implementation pending)

## RE_EVALUATION_LIMITS

limits:
  - cooldown:
    - duration: 60 minutes default (configurable)
    - rationale: Prevent excessive re-evaluations, reduce system load
    - behavior: Re-evaluation blocked if last evaluation was <cooldown minutes ago
    - bypass: Use force=true to bypass cooldown (manual re-evaluation)
  - daily_limit:
    - limit: 6 re-evaluations per plan per day (configurable)
    - rationale: Prevent excessive re-evaluations, ensure system stability
    - behavior: Re-evaluation blocked if daily limit reached
    - reset: Count resets at midnight UTC
    - bypass: Use force=true to bypass daily limit (manual re-evaluation)

## CHECKING_RE_EVALUATION_STATUS

api_usage:
  - tool: moneybot.get_auto_plan_status
  - response_fields:
    - last_re_evaluation: string (timestamp) - Last re-evaluation time
    - re_evaluation_count_today: integer - Number of re-evaluations today
    - re_evaluation_cooldown_remaining: integer (seconds) - Time until next re-evaluation allowed
    - re_evaluation_available: boolean - Whether re-evaluation is available (not in cooldown, under daily limit)
  - interpretation:
    - available_true: Re-evaluation can be triggered (not in cooldown, under daily limit)
    - available_false: Re-evaluation blocked (in cooldown or daily limit reached)
    - cooldown_remaining: Time until cooldown expires (in seconds)
    - count_today: Number of re-evaluations performed today (resets at midnight UTC)

## MANUAL_RE_EVALUATION

manual_trigger:
  - tool: moneybot.re_evaluate_plan
  - parameters:
    - plan_id: string (required) - Plan to re-evaluate
    - force: boolean (optional) - Force re-evaluation even if in cooldown or over daily limit
  - returns:
    - action: string - Recommended action (keep/update/cancel_replace/create_additional)
    - recommendation: string - Explanation of recommended action
    - available: boolean - Whether re-evaluation was available (before force)
    - last_re_evaluation: string - Updated re-evaluation timestamp
    - re_evaluation_count_today: integer - Updated count for today
  - use_cases:
    - market_conditions_changed: Market moved significantly, user wants to review plan
    - structure_break: Key support/resistance broken, user wants to check plan validity
    - time_passed: Plan is old, user wants to verify it's still valid
    - force_review: User wants to force re-evaluation regardless of cooldown/limit

## RE_EVALUATION_BEST_PRACTICES

recommendations:
  - monitor_plans:
    - check_re_evaluation_status: Periodically check re_evaluation_available for pending plans
    - review_recommendations: Review re-evaluation recommendations before applying
    - manual_trigger: Use manual re-evaluation when market conditions change significantly
  - plan_creation:
    - appropriate_tolerance: Use appropriate tolerance to avoid premature re-evaluations
    - reasonable_expiration: Set reasonable expiration times (not too long)
    - valid_conditions: Ensure conditions are still valid when creating plan
  - plan_management:
    - review_old_plans: Review plans that haven't been re-evaluated recently (>4 hours)
    - update_if_needed: If re-evaluation recommends update, consider updating plan
    - cancel_if_invalid: If re-evaluation recommends cancel_replace, consider cancelling and creating new plan
    - create_additional_if_opportunity: If re-evaluation recommends create_additional, consider creating complementary plan

## RE_EVALUATION_COMMON_MISTAKES

mistakes_to_avoid:
  - ignoring_re_evaluation_status:
    - mistake: Not checking re_evaluation_available for pending plans
    - consequence: Plans may not be re-evaluated when needed
    - fix: Periodically check re_evaluation_available, especially for long-running plans
  - too_frequent_manual_re_evaluation:
    - mistake: Manually triggering re-evaluation too frequently
    - consequence: Unnecessary system load, may hit daily limit
    - fix: Only manually trigger when market conditions change significantly
  - not_reviewing_recommendations:
    - mistake: Not reviewing re-evaluation recommendations
    - consequence: Plans may become suboptimal without user awareness
    - fix: Review re-evaluation recommendations, especially for update/cancel_replace actions
  - ignoring_cooldown:
    - mistake: Trying to re-evaluate plans in cooldown without force
    - consequence: Re-evaluation blocked, may miss opportunities
    - fix: Use force=true only when necessary, understand cooldown purpose

---

# INTEGRATION_GUIDE

## FEATURE_INTEGRATION

how_features_work_together:
  - tolerance_zones_and_multi_level:
    - relationship: Tolerance applies to all entry levels in multi-level plans
    - usage: Each level has its own zone (level_price ± tolerance)
    - execution: First level to enter its zone triggers execution
  - tolerance_zones_and_cancellation:
    - relationship: Cancellation checks use tolerance zone calculations
    - usage: Price distance cancellation uses same tolerance logic
  - multi_level_and_cancellation:
    - relationship: Cancellation checks closest entry level for multi-level plans
    - usage: Price distance calculated from closest entry level
  - re_evaluation_and_cancellation:
    - relationship: Re-evaluation runs before cancellation checks
    - usage: Re-evaluation may recommend cancel_replace, which triggers cancellation
  - all_features_together:
    - example: Multi-level plan with tolerance zones, monitored for cancellation and re-evaluation
    - workflow: Plan created → Zone entry tracked → Cancellation risk monitored → Re-evaluation triggered when needed

## TOOL_USAGE_SUMMARY

create_plan_with_all_features:
  - tool: moneybot.create_auto_trade_plan
  - parameters:
    - symbol: string (required)
    - direction: BUY or SELL (required)
    - entry: float (required) - Base entry price
    - stop_loss: float (required)
    - take_profit: float (required)
    - volume: float (required)
    - conditions: dict (required) - Include tolerance, price_near, etc.
    - entry_levels: array (optional) - Multi-level entry array
    - expiration_hours: integer (optional) - Plan expiration
  - example:
    - symbol: "BTCUSDc"
    - direction: "BUY"
    - entry: 50000.0
    - stop_loss: 49500.0
    - take_profit: 51000.0
    - volume: 0.01
    - conditions: {"price_near": 50000.0, "tolerance": 100.0, "order_block": true}
    - entry_levels: [{"price": 49900.0, "sl_offset": 500.0, "tp_offset": 1000.0}, {"price": 50000.0, "sl_offset": 600.0, "tp_offset": 1200.0}]
    - expiration_hours: 24

check_plan_status:
  - tool: moneybot.get_auto_plan_status
  - returns_all_phases:
    - Phase 1: in_tolerance_zone, zone_entry_tracked, zone_entry_time, price_distance_from_entry
    - Phase 2: entry_levels, triggered_level_index (if executed)
    - Phase 3: cancellation_risk, cancellation_reasons, cancellation_priority, cancellation_reason
    - Phase 4: last_re_evaluation, re_evaluation_count_today, re_evaluation_cooldown_remaining, re_evaluation_available

manual_re_evaluation:
  - tool: moneybot.re_evaluate_plan
  - parameters:
    - plan_id: string (required)
    - force: boolean (optional) - Bypass cooldown and daily limit

## CONFIGURATION

config_file: config/auto_execution_adaptive_config.json

config_structure:
  - cancellation_rules:
    - price_distance_thresholds: Symbol-specific thresholds
    - price_distance_cancellation: Enabled/disabled, check interval
    - time_based_cancellation: Enabled/disabled, max age, price distance threshold
    - structure_cancellation: Enabled/disabled, check interval
    - condition_invalidation: Enabled/disabled, check interval
  - re_evaluation_rules:
    - enabled: boolean - Enable/disable re-evaluation system
    - price_movement_threshold: float - Price movement threshold (default: 0.2%)
    - time_based_trigger_hours: integer - Time-based trigger interval (default: 4 hours)
    - cooldown_minutes: integer - Cooldown between re-evaluations (default: 60 minutes)
    - daily_limit: integer - Maximum re-evaluations per day (default: 6)
    - structure_change_enabled: boolean - Enable structure change trigger (default: true)
    - volatility_regime_enabled: boolean - Enable volatility regime trigger (default: false)

---

# SUMMARY

## KEY_POINTS

tolerance_zones:
  - tolerance_creates_zone: Not exact price, but execution zone
  - zone_entry_tracked: System tracks when price enters zone
  - execute_once: Plan executes once on zone entry, not continuously
  - retry_on_re_entry: If price exits and re-enters, plan can retry
  - symbol_specific: Use recommended tolerance ranges based on symbol volatility
  - always_include: Include tolerance in conditions dict for clarity

multi_level_entry:
  - multiple_levels_enable: Better fill rates, capture opportunities at different prices
  - execution_priority: First level in array to enter zone triggers execution
  - level_specific_sl_tp: Each level can have custom SL/TP offsets
  - recommended_usage: 2-3 levels for key setups (OB zones, liquidity sweeps, range boundaries)
  - meaningful_levels: Base levels on technical analysis, not arbitrary prices
  - spacing_important: Levels should be at least 1x tolerance apart for clear separation

conditional_cancellation:
  - conditional_cancellation_enables: Automatic cleanup of invalid plans
  - cancellation_conditions: Price distance, time-based, structure, condition invalidation
  - priority_system: High/medium/low priority determines cancellation urgency
  - risk_monitoring: Check cancellation_risk to monitor plan health
  - best_practices: Monitor plans, use appropriate tolerance, update if needed
  - configuration: Symbol-specific thresholds in config file

plan_re_evaluation:
  - re_evaluation_enables: Automatic adaptation of plans to changing market conditions
  - re_evaluation_triggers: Price movement, time-based, structure change, volatility regime
  - re_evaluation_actions: Keep, update, cancel_replace, create_additional
  - re_evaluation_limits: Cooldown (60 min) and daily limit (6 per day)
  - manual_re_evaluation: Use moneybot.re_evaluate_plan to manually trigger
  - best_practices: Monitor plans, review recommendations, update if needed
  - configuration: Configurable thresholds and limits in config file

## QUICK_REFERENCE

when_to_use_tolerance_zones:
  - Always: Include tolerance in all plans for better fill rates
  - Wider: High volatility, range trading, news events
  - Narrower: Stable markets, precise entries, tight stops

when_to_use_multi_level:
  - Order block zones: Multiple OB levels detected
  - Liquidity sweeps: Sweep + retest levels
  - Range boundaries: Support + resistance levels
  - Fibonacci levels: Multiple retracement levels

when_to_check_cancellation:
  - Periodically: Check cancellation_risk for all pending plans
  - High risk: If risk >0.8, consider updating or cancelling
  - Long-running: Plans older than 12 hours should be monitored

when_to_trigger_re_evaluation:
  - Price moved: Significant price movement (>0.2% from entry)
  - Time passed: Plan age >= 4 hours
  - Structure changed: Key support/resistance broken
  - Manual review: User wants to review plan validity

---

**Last Updated:** 2025-12-18  
**Status:** Complete - All Phase 1-4 features documented  
**Replaces:** 22.TOLERANCE_ZONE_EXECUTION.md, 23.MULTI_LEVEL_ENTRY_STRATEGY.md, 24.CONDITIONAL_CANCELLATION.md, 25.PLAN_RE_EVALUATION.md

