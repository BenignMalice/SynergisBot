# How the Summary is Created

**Date:** 2025-12-12  
**Purpose:** Explain how the `analyse_symbol_full` tool generates the summary text

---

## üìä Overview

The summary is generated by the `_format_unified_analysis()` function in `desktop_agent.py`. It's built as a single f-string that combines multiple sections of analysis data.

---

## üîß Function Location

**File:** `desktop_agent.py`  
**Function:** `_format_unified_analysis()`  
**Lines:** 
- First instance: ~861-1400
- Second instance: ~6990-7600 (duplicate - should be identical)

**Note:** There are two identical copies of this function in the file. They should be kept in sync.

---

## üìù Summary Structure

The summary is built in this order:

### 1. Header Section
```python
üìä {symbol} - Unified Analysis
üìÖ {timestamp} | Price: ${current_price:,.2f}
```

### 2. Bias & Regime Section
```python
{confidence_emoji} BIAS CONFIDENCE: {confidence_score}/100
üèõÔ∏è MARKET REGIME: {regime_classification}
{volatility_regime_display}
```

### 3. Macro Context Section
```python
üåç MACRO CONTEXT
{macro_summary}
‚Üí Macro Bias: {macro_bias_str}
```

### 4. SMC Structure Section
```python
üèõÔ∏è SMC STRUCTURE (H4 ‚Üí H1 ‚Üí M30 ‚Üí M15 ‚Üí M5)
H4: {h4_status}
H1: {h1_status}
M30: {m30_status}
M15: {m15_status}
M5: {m5_status}
CHOCH/BOS: {choch_bos_status}
‚Üí Structure: {structure_trend}
```

### 5. Candle Patterns Section
```python
üïØÔ∏è CANDLE PATTERNS
{pattern_summary}
```

### 6. Advanced Features Section
```python
‚öôÔ∏è ADVANCED FEATURES
RMAG: {rmag_value} ATR ({status})
VWAP: {vwap_zone} zone
Volatility: {volatility_regime}
Momentum: {momentum_ratio} ({status})
‚Üí Technicals: {summary}
```

### 7. Technical Indicators Section
```python
üìà TECHNICAL INDICATORS
{technical_indicators_summary}
```

### 8. Binance Enrichment Section
```python
üìä BINANCE ENRICHMENT
{binance_enrichment_summary}
```

### 9. Liquidity & Order Flow Section
```python
üíß LIQUIDITY & ORDER FLOW
{liquidity_summary}
```

### 10. BTC Order Flow Metrics Section (BTC only)
```python
üìä BTC ORDER FLOW METRICS (Binance Real-Time):
{btc_order_flow_summary}
```

### 11. Market Context Section
```python
üìä MARKET CONTEXT
{market_context_summary}
```

### 12. Session & News Section
```python
üïí Session: {session_name} ¬∑ {minutes_remaining}min remaining
üì∞ News: {next_event} in {time_remaining} ({impact} impact)
```

### 13. Volatility Forecasting Section
```python
üìâ VOLATILITY FORECASTING
Volatility Signal: {volatility_signal}
{volatility_summary}
```

### 14. M1 Microstructure Section
```python
üî¨ M1 MICROSTRUCTURE ANALYSIS
{m1_microstructure_summary}
```

### 15. Enhanced Data Fields Section ‚≠ê
```python
üìä ENHANCED DATA FIELDS ‚≠ê NEW
{_format_enhanced_data_fields_summary(...)}
```

**This is where Enhanced Data Fields are added!**

### 16. Confluence Verdict Section
```python
üéØ CONFLUENCE VERDICT
{confluence_verdict}
{confluence_action}
Risk Level: {confluence_risk}
```

### 17. Layered Recommendations Section
```python
üìà LAYERED RECOMMENDATIONS
{scalp_recommendation}
{intraday_recommendation}
{swing_recommendation}
```

---

## üîç Enhanced Data Fields Formatting

**Function:** `_format_enhanced_data_fields_summary()`  
**Location:** `desktop_agent.py` line ~1633

### How It Works

The function takes 7 optional parameters:
1. `correlation_context` - Correlation data (DXY, SP500, US10Y, BTC)
2. `htf_levels` - Higher timeframe levels (weekly/monthly opens)
3. `session_risk` - Session risk data (rollover, news lock)
4. `execution_context` - Execution quality (spread, slippage)
5. `strategy_stats` - Strategy performance statistics
6. `structure_summary` - Structure summary (range type, liquidity sweeps)
7. `symbol_constraints` - Symbol constraints (max trades, max risk)

### Display Logic

**Key Behavior:** The function only displays fields that are:
- ‚úÖ Available (not None)
- ‚úÖ Not empty (not `{}`)
- ‚úÖ Not null (not `null`)
- ‚úÖ Have valid data (for correlation_context, checks `data_quality != 'unavailable'`)

**Missing/Unavailable Fields:** Are **NOT displayed** in the summary (by design).

### Example Output

**When fields are available:**
```
üìä ENHANCED DATA FIELDS ‚≠ê NEW
üö´ Execution Quality: POOR
   - Spread elevated
üèóÔ∏è Structure: Accumulation, Mid Range
‚öôÔ∏è Constraints: Max trades: 1, Max risk: 2.0%
```

**When fields are unavailable:**
```
üìä ENHANCED DATA FIELDS ‚≠ê NEW
Enhanced data fields unavailable
```

**Or if some fields are available:**
```
üìä ENHANCED DATA FIELDS ‚≠ê NEW
üö´ Execution Quality: POOR
   - Spread elevated
üèóÔ∏è Structure: Accumulation, Mid Range
‚öôÔ∏è Constraints: Max trades: 1, Max risk: 2.0%
```

(Note: Missing fields like correlation_context, htf_levels, session_risk, strategy_stats are simply not shown)

---

## ‚ö†Ô∏è Important Design Decision

**The summary intentionally hides missing/unavailable Enhanced Data Fields.**

This is by design - the `_format_enhanced_data_fields_summary()` function only displays fields that have data. Missing fields are not shown.

**Why This Matters:**
- ChatGPT sees the summary text, not the raw data structure
- If a field is missing/unavailable, it won't appear in the summary
- ChatGPT must check the `data` object to see if fields are missing
- ChatGPT must acknowledge missing fields even though they're not in the summary

---

## üìä Data Structure vs Summary

### Summary (What ChatGPT Sees)
- Text-only representation
- Only shows available fields
- Missing fields are hidden

### Data Object (What ChatGPT Can Check)
- Full structured data
- All fields present (even if `null`, `{}`, or `unavailable`)
- ChatGPT can check `data.correlation_context.data_quality == 'unavailable'`
- ChatGPT can check `data.htf_levels == {}`
- ChatGPT can check `data.session_risk == {}`
- ChatGPT can check `data.strategy_stats == null`

---

## üéØ Key Takeaway

**The summary is a display layer, not the source of truth.**

ChatGPT should:
1. ‚úÖ Read the summary for available data
2. ‚úÖ Check the `data` object for missing/unavailable fields
3. ‚úÖ Acknowledge missing fields even if they're not in the summary
4. ‚úÖ Use the required format: "‚ö†Ô∏è [Field] unavailable - cannot [capability]"

---

## üîß Code Reference

**Summary Generation:**
```python
# desktop_agent.py line ~1236
summary = f"""üìä {symbol} - Unified Analysis
...
üìä ENHANCED DATA FIELDS ‚≠ê NEW
{_format_enhanced_data_fields_summary(correlation_context, htf_levels, session_risk, execution_context, strategy_stats, structure_summary, symbol_constraints)}
...
"""
```

**Enhanced Data Fields Formatting:**
```python
# desktop_agent.py line ~1633
def _format_enhanced_data_fields_summary(...) -> str:
    lines = []
    
    # Only add lines for available fields
    if correlation_context and correlation_context.get('data_quality') != 'unavailable':
        # Add correlation line
    if htf_levels:
        # Add HTF levels line
    if session_risk:
        # Add session risk line
    if execution_context:
        # Add execution context line
    if strategy_stats:
        # Add strategy stats line
    if structure_summary:
        # Add structure summary line
    if symbol_constraints:
        # Add symbol constraints line
    
    return "\n".join(lines) if lines else "Enhanced data fields unavailable"
```

---

## üìù Summary

1. **Summary is built** by `_format_unified_analysis()` as a single f-string
2. **Enhanced Data Fields** are formatted by `_format_enhanced_data_fields_summary()`
3. **Missing fields are hidden** in the summary (by design)
4. **ChatGPT must check** the `data` object to see missing fields
5. **ChatGPT must acknowledge** missing fields even if not in summary

---

**Last Updated:** 2025-12-12

